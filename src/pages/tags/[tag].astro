---
import Back from "@components/Back.astro";
import BaseHead from "@components/BaseHead.astro";
import Footer from "@components/Footer.astro";
import Header from "@components/Header.astro";
import PostItem from "@components/PostItem.astro";
import { SITE_TITLE } from "../../consts";
import { getPublishedPosts, groupPostsByYear } from "../../utils/posts";

export const prerender = true;

export async function getStaticPaths() {
    const posts = await getPublishedPosts();
    const uniqueTags = [...new Set(posts.flatMap((post) => post.data.tags || []))];

    return uniqueTags.map((tag) => ({
        params: { tag },
        props: {
            posts: posts.filter((post) => (post.data.tags || []).includes(tag)),
        },
    }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const groupedPosts = groupPostsByYear(posts);
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead
			title={`Tag: ${tag} | ${SITE_TITLE}`}
			description={`All posts tagged with "${tag}"`}
		/>
	</head>
	<body>
		<Header />
		<main class="page-shell" transition:animate="fade">
			<Back href="/tags" />
			<h1 class="text-2xl sm:text-3xl font-bold text-primary mb-4">#{tag}</h1>
			<section class="section-stack">
				{groupedPosts.map(([year, yearPosts]) => (
					<div class="relative" data-year-group>
						<div class="relative h-14 pointer-events-none select-none">
							<span class="absolute -left-7 sm:-left-10 -top-1 text-8xl sm:text-9xl font-bold opacity-[0.06] text-primary">
								{year}
							</span>
						</div>

						<ul class="m-0 flex list-none flex-col gap-1 p-0 relative">
							{yearPosts.map((post) => (
								<PostItem post={post} />
							))}
						</ul>
					</div>
				))}
			</section>
		</main>
		<Footer />
	</body>
</html>
