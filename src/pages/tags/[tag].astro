---
import { getCollection } from "astro:content";
import Back from "../../components/Back.astro";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import { SITE_TITLE } from "../../consts";

export const prerender = true;

export async function getStaticPaths() {
    const blogPosts = await getCollection("blog");
    const allPosts = [...blogPosts].filter(
        (post) => !post.data.hidden,
    );
    const uniqueTags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))];

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts.filter((post) => (post.data.tags || []).includes(tag));
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const sortedPosts = posts
    .filter((post) => !post.data.hidden)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
    const year = String(post.data.pubDate.getFullYear());
    if (!acc.has(year)) {
        acc.set(year, []);
    }
    acc.get(year)?.push(post);
    return acc;
}, new Map<string, typeof sortedPosts>());

const groupedPosts = Array.from(postsByYear.entries());
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead
			title={`Tag: ${tag} | ${SITE_TITLE}`}
			description={`All posts tagged with "${tag}"`}
		/>
	</head>
	<body>
		<Header />
		<main class="page-shell">
			<Back href="/tags" />
			<h1 class="text-2xl sm:text-3xl font-bold text-primary mb-4">#{tag}</h1>
			<section class="section-stack">
				{groupedPosts.map(([year, yearPosts]) => (
					<div class="relative" data-year-group>
						<div class="relative h-14 pointer-events-none select-none">
							<span class="absolute -left-7 sm:-left-10 -top-1 text-8xl sm:text-9xl font-bold opacity-[0.06] text-primary">
								{year}
							</span>
						</div>

						<ul class="m-0 flex list-none flex-col gap-1 p-0 relative">
							{yearPosts.map((post) => {
								const isZh = post.data.lang === 'zh';
								return (
									<li class="post-item-wrapper">
										<a
											href={`/posts/${post.id}`}
											class="post-item group flex flex-col gap-0 py-1 no-underline"
											data-post-id={post.id}
										>
											<div class="text-base sm:text-lg leading-tight text-primary">
												{isZh && (
													<span class="zh-badge text-xs border border-current rounded px-1 opacity-60 align-middle">中文</span>
												)}
												<span class="break-words align-middle">{post.data.title}</span>
											</div>

											<time class="block text-xs opacity-50 tabular-nums" data-no-preview>
												<FormattedDate date={post.data.pubDate} />
											</time>
										</a>
									</li>
								);
							})}
						</ul>
					</div>
				))}
			</section>
		</main>
		<Footer />
	</body>
</html>

<style lang="scss">
	.zh-badge {
		margin-left: -2.75rem;
	}

	@media (max-width: 640px) {
		.zh-badge {
			margin-left: 0;
			margin-right: 0.5rem;
		}
	}
</style>
