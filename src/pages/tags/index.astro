---
import BaseHead from "@components/BaseHead.astro";
import Footer from "@components/Footer.astro";
import Header from "@components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import { getPublishedPosts } from "../../utils/posts";

const posts = await getPublishedPosts();
const tagCountMap = new Map<string, number>();

posts.forEach((post) => {
    (post.data.tags || []).forEach((tag) => {
        if (!tag) return;
        tagCountMap.set(tag, (tagCountMap.get(tag) ?? 0) + 1);
    });
});

// Sort tags by count (descending), then alphabetically
const sortedTags = Array.from(tagCountMap.entries()).sort((a, b) => {
    if (b[1] === a[1]) {
        return a[0].localeCompare(b[0], "zh-Hans-u-nu-latn");
    }
    return b[1] - a[1];
});

// Group tags by count tiers
const tagsByTier = sortedTags.reduce((acc, [tag, count]) => {
    let tier: string;
    if (count >= 10) tier = "10+";
    else if (count >= 5) tier = "5-9";
    else if (count >= 3) tier = "3-4";
    else tier = "1-2";

    if (!acc.has(tier)) acc.set(tier, []);
    acc.get(tier)?.push([tag, count] as [string, number]);
    return acc;
}, new Map<string, [string, number][]>());

const tierOrder = ["10+", "5-9", "3-4", "1-2"];
const groupedTags = tierOrder.filter((tier) => tagsByTier.has(tier)).map((tier) => [tier, tagsByTier.get(tier)] as const);

const totalTags = sortedTags.length;
const pageTitle = "Tags";
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`${pageTitle} | ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="page-shell" transition:animate="fade">
			<h1 class="text-2xl sm:text-3xl font-bold text-primary mb-4">{pageTitle}</h1>
			<section class="section-stack">
				{groupedTags.map(([tier, tags]) => (
					<div class="relative" data-tier-group>
						<div class="relative h-14 pointer-events-none select-none">
							<span class="absolute -left-7 sm:-left-10 -top-1 text-8xl sm:text-9xl font-bold opacity-[0.06] text-primary">
								{tier}
							</span>
						</div>

						<ul class="m-0 flex list-none flex-col gap-1 p-0 relative">
							{tags && tags.map(([tag, count]) => (
								<li class="tag-item-wrapper">
									<a
										href={`/tags/${tag}`}
										class="tag-item group flex items-baseline gap-4 py-1 no-underline"
									>
										<span class="text-base sm:text-lg leading-tight text-primary break-words">
											{tag}
										</span>
										<span class="text-xs opacity-50 tabular-nums">
											{count} {count === 1 ? 'post' : 'posts'}
										</span>
									</a>
								</li>
							))}
						</ul>
					</div>
				))}
			</section>
		</main>
		<Footer />
	</body>
</html>
