---
import type { CollectionEntry } from "astro:content";
import type { MarkdownHeading, ImageMetadata } from "astro";
import Back from "../components/Back.astro";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import Lightbox from "../components/Lightbox.astro";
import Prose from "../components/Prose.astro";
import Comments from "../components/Comments.astro";
import ShareSidebar from "../components/ShareSidebar.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { DEFAULT_POST_SOCIAL_IMAGE } from "../consts";
import { extractDescription } from "../utils/extractDescription";
import { calculateReadingTime } from "../utils/readingTime";

type EntryData = CollectionEntry<"blog">["data"];

type Props = EntryData & {
    body?: string;
    headings?: MarkdownHeading[];
    lastModified?: string;
    lastModifiedCommitUrl?: string | null;
    frontmatter: Props;
};

// If it come from a page instead of a collection, we need to handle the pubDate from the frontmatter also
const rawProps = Astro.props.body ? Astro.props : { ...Astro.props.frontmatter, ...Astro.props };
const props = {
    ...rawProps,
    pubDate: new Date(rawProps.pubDate ?? rawProps.frontmatter.pubDate),
};

const {
    title,
    description: providedDescription,
    pubDate,
    updatedDate,
    socialImage,
    body,
    tags = [],
    headings = [],
    commentSystem,
    comment,
    lastModified,
    lastModifiedCommitUrl,
} = props;

const description =
    providedDescription || (body ? extractDescription(body) : "No description available");
const readingTime = body ? calculateReadingTime(body) : null;

// Extract image URL from socialImage (can be ImageMetadata or string)
const getImageUrl = (img: ImageMetadata | string | undefined): string => {
    if (!img) return DEFAULT_POST_SOCIAL_IMAGE;
    if (typeof img === "object" && "src" in img) return img.src;
    return img;
};
const imageSrc = getImageUrl(socialImage);

// Extract slug from URL path for like API
const slug = Astro.url.pathname.replace(/^\/|\/$/g, "");

// Only show TOC when article has enough headings (at least 2 h2/h3)
const showToc = headings.filter((heading) => heading.depth >= 2 && heading.depth <= 3).length >= 2;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={imageSrc} />
	</head>

	<body>
		<Header />
		<main class="page-shell max-w-none relative">
			<!-- Article main body: always centered -->
			<article class="mx-auto max-w-[50rem] sm:px-6">
				<Back />
				<!-- Header section -->
				<div data-article-header class="space-y-3">
					<h1 class="text-2xl leading-tight font-bold text-primary sm:text-3xl">{title}</h1>
					<div class="space-y-0.5 text-sm text-muted">
						<p>
							<FormattedDate date={pubDate} />
							{readingTime && (
								<>
									<span class="px-2 opacity-50">&middot;</span>
									<span>{readingTime}</span>
								</>
							)}
						</p>
						{
							(lastModified || updatedDate) && (
								<p>
									Last updated on {
										lastModifiedCommitUrl ? (
											<a
												href={lastModifiedCommitUrl}
												target="_blank"
												rel="noopener noreferrer"
												class="underline decoration-dotted underline-offset-4 hover:text-accent transition-colors"
											>
												<FormattedDate date={lastModified ? new Date(lastModified) : updatedDate!} />
											</a>
										) : (
											<FormattedDate date={lastModified ? new Date(lastModified) : updatedDate!} />
										)
									}
								</p>
							)
						}
					</div>
					{tags && tags.length > 0 && (
						<div class="flex flex-wrap gap-2">
							{tags.map((tag: string) => (
								<a
									href={`/tags/${tag}`}
									class="pill"
									data-tone="accent"
								>
									{tag}
								</a>
							))}
						</div>
					)}
				</div>

				<!-- Mobile TOC -->
				{showToc && (
					<>
						<!-- Mobile: Floating toggle button -->
						<button
							data-toc-mobile-toggle
							class="min-[1400px]:hidden fixed bottom-6 right-6 z-50 flex h-14 w-14 items-center justify-center rounded-full backdrop-blur-md bg-[rgba(251,143,104,0.85)] border border-[rgba(255,255,255,0.3)] text-white shadow-[0_8px_32px_rgba(251,143,104,0.35)] transition-all duration-300 hover:scale-105 hover:bg-[rgba(251,143,104,0.95)] hover:shadow-[0_12px_40px_rgba(251,143,104,0.45)] active:scale-95"
							aria-label="Open table of contents"
						>
							<svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
								<path d="M3 4h18M3 12h18M3 20h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
							</svg>
						</button>

						<!-- Mobile: Drawer -->
						<div
							data-toc-mobile-drawer
							class="min-[1400px]:hidden fixed inset-0 z-50 pointer-events-none"
							aria-hidden="true"
						>
							<!-- Overlay -->
							<div
								data-toc-mobile-overlay
								class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300 pointer-events-none"
							></div>

							<!-- Drawer content -->
							<div
								data-toc-mobile-content
								class="absolute right-0 top-0 h-full w-80 max-w-[85vw] bg-surface shadow-2xl translate-x-full transition-transform duration-300 pointer-events-auto"
							>
								<div class="flex h-full flex-col">
									<!-- Header -->
									<div class="flex items-center justify-between border-b border-border-subtle px-6 py-4">
										<h2 class="text-lg font-semibold text-primary">Contents</h2>
										<button
											data-toc-mobile-close
											class="flex h-8 w-8 items-center justify-center rounded-full hover:bg-muted transition-colors"
											aria-label="Close"
										>
											<svg class="h-5 w-5 text-muted" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
												<path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
											</svg>
										</button>
									</div>

									<!-- TOC content -->
									<div class="flex-1 overflow-y-auto px-6 pt-4 pb-8">
										<div class="toc-mobile">
											<TableOfContents headings={headings} />
										</div>
									</div>
								</div>
							</div>
						</div>
					</>
				)}

				<!-- Content -->
				<div class="pt-10 space-y-10 text-secondary">
					<Prose class="max-w-none text-secondary">
						<slot />
					</Prose>

					<Comments
						commentSystem={commentSystem}
						comment={comment}
						pageTitle={title}
					/>
					<Lightbox id="blog-lightbox" selector=".prose img:not([data-lightbox-skip])" />
				</div>
			</article>

			<!-- Desktop TOC: Fixed positioned on right side -->
			{showToc && (
				<aside
					data-toc-sidebar
					class="hidden min-[1400px]:block fixed w-[220px] min-[1400px]:w-[260px] opacity-0 transition-opacity duration-200"
					style="left: calc(50% + 25rem + 1.5rem); top: 6rem;"
				>
					<nav class="toc max-h-[calc(100vh-8rem)] overflow-y-auto">
						<TableOfContents headings={headings} />
					</nav>
				</aside>
			)}

			<!-- Share sidebar: Desktop left side, Mobile floating button -->
			<ShareSidebar title={title} description={description} tags={tags} slug={slug} />
		</main>
		<Footer />
	</body>
	<script>
		import { initBlogInteractive } from '../scripts/blog-interactive';
		import { initMermaid } from '../scripts/mermaid-init';
		import '../scripts/code-blocks';

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', () => {
				initBlogInteractive();
				initMermaid();
			}, { once: true });
		} else {
			initBlogInteractive();
			initMermaid();
		}
	</script>
</html>
