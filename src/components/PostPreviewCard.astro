---
/**
 * PostPreviewSetup - Injects post metadata and initializes hover preview
 *
 * This component should be included once per page (typically in the layout).
 * It generates a JSON blob of all post metadata at build time, which the
 * client-side script uses to render preview cards.
 */
import type { ImageMetadata } from "astro";
import { DEFAULT_POST_SOCIAL_IMAGE } from "../consts";
import { extractDescription } from "../utils/extractDescription";
import { getAllRenderablePosts } from "../utils/posts";

interface PostMeta {
    title: string;
    description: string;
    image?: string;
}

interface Props {
    /** Override the auto-generated metadata map */
    meta?: Record<string, PostMeta>;
}

const { meta } = Astro.props as Props;

// Extract image URL from various formats
function getImageUrl(socialImage: ImageMetadata | string | undefined): string | undefined {
    if (!socialImage) return undefined;
    if (typeof socialImage === "object" && "src" in socialImage) {
        return socialImage.src;
    }
    return socialImage;
}

// Build metadata map from posts collection
async function buildMetaMap(): Promise<Record<string, PostMeta>> {
    const posts = await getAllRenderablePosts();

    return posts.reduce<Record<string, PostMeta>>((acc, post) => {
        const description = post.data.description || extractDescription(post.body || "");
        const image = getImageUrl(post.data.socialImage) || DEFAULT_POST_SOCIAL_IMAGE;

        acc[post.id] = {
            title: post.data.title,
            description,
            image,
        };
        return acc;
    }, {});
}

const postMetaMap = meta ?? (await buildMetaMap());

// Escape < to prevent XSS in JSON embedded in HTML
const serializedMeta = JSON.stringify(postMetaMap).replace(/</g, "\\u003c");
---

<script id="all-posts-meta" type="application/json" set:html={serializedMeta} is:inline></script>
<script>
    import { initPostPreview } from "../scripts/post-preview.ts";
    initPostPreview(document);
    document.addEventListener("astro:page-load", () => initPostPreview(document));
</script>

<style lang="scss" is:global>
    @use "../styles/components/post-preview";
</style>
