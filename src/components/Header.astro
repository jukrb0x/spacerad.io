---
import { SITE_TITLE } from "../consts";
import SearchModal from "./SearchModal.astro";
import ThemeToggle from "./ThemeToggle.astro";

const navLinks = [
    { href: "/", label: "Home" },
    { href: "/posts", label: "Blog" },
    { href: "/tags", label: "Tags" },
    { href: "/channel", label: "Channel" },
    { href: "/about", label: "About" },
];

const pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, "");
const subpath = pathname.match(/[^/]+/g);
const isActive = (href: string) => href === pathname || href === `/${subpath?.[0] || ""}`;
---

<header
    data-header
    class="header-wrapper sticky top-0 z-sticky bg-surface border-b border-border transition-all duration-300"
>
    <!-- Subtle neon glow effect on scroll -->
    <div
        data-header-glow
        class="header-glow absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-500"
    ></div>

    <!-- Reading progress indicator -->
    <div
        data-reading-progress
        class="absolute bottom-0 left-0 w-full h-0.5 origin-left transform scale-x-0"
        style="background: var(--gradient-warm-to-cool)"
        role="progressbar"
        aria-label="Reading progress"
        aria-valuenow="0"
        aria-valuemin="0"
        aria-valuemax="100"
    ></div>

    <nav
        class="mx-auto flex w-full max-w-7xl items-center justify-between gap-4 px-2 py-2 sm:px-4"
    >
        <!-- Left: Logo + Site Name -->
        <h2
            class="text-[1.1rem] font-semibold tracking-tight text-primary sm:text-[1.15rem] shrink-0"
        >
            <a
                href="/"
                class="inline-flex items-center gap-2 no-underline transition-interactive hover:text-accent focus-accent"
            >
                <span class="text-xl" aria-hidden="true">ðŸ“»</span>
                <span>{SITE_TITLE}</span>
            </a>
        </h2>

        <!-- Right: Search | NavLinks | ThemeToggle -->
        <div class="flex items-center gap-1 sm:gap-2">
            <!-- Search -->
            <SearchModal />

            <!-- Spacer -->
            <!-- <span class="hidden sm:block text-border mx-1 select-none">|</span> -->

            <!-- Nav Links (desktop) -->
            <div class="hidden items-center gap-1 md:flex" data-no-preview>
                {
                    navLinks.map((link) => (
                        <a
                            href={link.href}
                            class:list={[
                                "no-underline nav-link px-3 py-1.5 text-[0.9rem] font-medium rounded-md transition-all duration-200",
                                isActive(link.href)
                                    ? "text-muted cursor-default"
                                    : "text-secondary hover:text-accent hover:bg-accent-tint-6",
                            ]}
                        >
                            {link.label}
                        </a>
                    ))
                }
            </div>

            <!-- Spacer -->
            <span class="hidden sm:block text-border mx-1 select-none">|</span>

            <!-- Theme Toggle -->
            <ThemeToggle variant="header" />

            <!-- Mobile menu toggle -->
            <button
                type="button"
                class="icon-btn icon-btn--sm icon-btn--square icon-btn--bordered focus-accent md:hidden ml-1"
                aria-label="Open navigation menu"
                aria-expanded="false"
                data-nav-toggle
            >
                <span
                    aria-hidden="true"
                    class="flex h-4 w-5 flex-col justify-between"
                >
                    <span
                        class="h-0.5 w-full rounded-full bg-current transition-transform duration-300"
                        data-bar-top></span>
                    <span
                        class="h-0.5 w-full rounded-full bg-current transition-opacity duration-300"
                        data-bar-middle></span>
                    <span
                        class="h-0.5 w-full rounded-full bg-current transition-transform duration-300"
                        data-bar-bottom></span>
                </span>
            </button>
        </div>
    </nav>
    <div
        data-nav-overlay
        class="fixed inset-0 z-40 flex items-start justify-end bg-black/30 opacity-0 transition-opacity duration-200 pointer-events-none md:hidden"
        data-nav-state="closed"
    >
        <button
            type="button"
            class="absolute inset-0 h-full w-full cursor-default"
            data-nav-close
            aria-label="Close navigation menu"></button>
        <div
            data-nav-drawer
            class="relative z-10 flex h-full w-72 max-w-[80vw] translate-x-6 flex-col gap-6 border-l border-border bg-surface p-6 text-primary shadow-xl transition-transform duration-200"
        >
            <div class="flex items-center justify-between">
                <span
                    class="text-sm font-semibold uppercase tracking-[0.25em] text-[color-mix(in_srgb,var(--color-text-muted)_70%,transparent)]"
                >
                    Menu
                </span>
                <button
                    type="button"
                    class="icon-btn icon-btn--xs icon-btn--square focus-accent"
                    data-nav-close
                    aria-label="Close navigation menu"
                >
                    <span aria-hidden="true" class="text-xl leading-none"
                        >Ã—</span
                    >
                </button>
            </div>
            <nav class="flex flex-col gap-2 text-base" data-no-preview>
                {
                    navLinks.map((link) => (
                        <a
                            href={link.href}
                            class:list={[
                                "inline-flex items-center rounded-md px-3 py-2 transition-interactive focus-accent",
                                isActive(link.href)
                                    ? "text-muted cursor-default"
                                    : "text-secondary hover:text-accent hover:bg-accent-tint-8",
                            ]}
                            data-nav-link
                        >
                            {link.label}
                        </a>
                    ))
                }
            </nav>
        </div>
    </div>
    <link
        rel="alternate"
        type="application/rss+xml"
        title={SITE_TITLE}
        href={new URL("rss.xml", Astro.site)}
    />
</header>

<script is:inline>
    const toggleButton = document.querySelector("[data-nav-toggle]");
    const overlay = document.querySelector("[data-nav-overlay]");
    const drawer = document.querySelector("[data-nav-drawer]");
    const closeButtons = document.querySelectorAll("[data-nav-close]");
    const navLinks = document.querySelectorAll("[data-nav-link]");
    const barTop = toggleButton?.querySelector("[data-bar-top]");
    const barMiddle = toggleButton?.querySelector("[data-bar-middle]");
    const barBottom = toggleButton?.querySelector("[data-bar-bottom]");
    let lastFocusedElement = null;

    // Helper to toggle multiple classes based on state
    const toggleClasses = (el, add, remove) => {
        if (!el) return;
        el.classList.remove(...remove);
        el.classList.add(...add);
    };

    const setOpen = (open) => {
        if (!overlay || !drawer) return;

        overlay.dataset.navState = open ? "open" : "closed";
        toggleButton?.setAttribute("aria-expanded", String(open));
        toggleButton?.setAttribute("aria-label", open ? "Close navigation menu" : "Open navigation menu");

        if (open) {
            lastFocusedElement = document.activeElement;
            toggleClasses(overlay, ["opacity-100"], ["pointer-events-none", "opacity-0"]);
            toggleClasses(drawer, ["translate-x-0"], ["translate-x-6"]);
            toggleClasses(barTop, ["translate-y-1.5", "rotate-45"], []);
            toggleClasses(barBottom, ["-translate-y-1.5", "-rotate-45"], []);
            toggleClasses(barMiddle, ["opacity-0"], []);
            document.body.classList.add("scroll-locked");
            requestAnimationFrame(() => navLinks[0]?.focus({ preventScroll: true }));
        } else {
            toggleClasses(overlay, ["opacity-0", "pointer-events-none"], ["opacity-100"]);
            toggleClasses(drawer, ["translate-x-6"], ["translate-x-0"]);
            toggleClasses(barTop, [], ["translate-y-1.5", "rotate-45"]);
            toggleClasses(barBottom, [], ["-translate-y-1.5", "-rotate-45"]);
            toggleClasses(barMiddle, [], ["opacity-0"]);
            document.body.classList.remove("scroll-locked");
            if (lastFocusedElement && "focus" in lastFocusedElement) {
                lastFocusedElement.focus({ preventScroll: true });
            }
        }
    };

    toggleButton?.addEventListener("click", () => setOpen(overlay?.dataset.navState !== "open"));
    closeButtons.forEach((btn) => btn.addEventListener("click", () => setOpen(false)));
    overlay?.addEventListener("click", (e) => e.target === overlay && setOpen(false));
    document.addEventListener("keydown", (e) => e.key === "Escape" && setOpen(false));
    navLinks.forEach((link) => link.addEventListener("click", () => setOpen(false)));

    // Close drawer when viewport becomes desktop-sized
    const mdQuery = window.matchMedia("(min-width: 768px)");
    mdQuery.addEventListener("change", (e) => e.matches && setOpen(false));
</script>

<script>
    import "../scripts/header-scroll.ts";
</script>

<style lang="scss">
    /* Prevent flash of mobile nav toggle on desktop */
    @media (min-width: 768px) {
        [data-nav-toggle] {
            display: none !important;
        }
    }

    /* Subtle neon/space-radio glow effect */
    .header-glow {
        background: linear-gradient(
            90deg,
            transparent 0%,
            color-mix(in srgb, var(--color-space-purple) 3%, transparent) 20%,
            color-mix(in srgb, var(--color-space-cyan) 5%, transparent) 50%,
            color-mix(in srgb, var(--color-space-purple) 3%, transparent) 80%,
            transparent 100%
        );
    }

    :global([data-theme="dark"]) .header-glow {
        background: linear-gradient(
            90deg,
            transparent 0%,
            color-mix(in srgb, var(--color-space-purple) 8%, transparent) 20%,
            color-mix(in srgb, var(--color-space-cyan) 12%, transparent) 50%,
            color-mix(in srgb, var(--color-space-purple) 8%, transparent) 80%,
            transparent 100%
        );
    }

    .header-wrapper.is-scrolled .header-glow {
        opacity: 1;
    }
</style>
