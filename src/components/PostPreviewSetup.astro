---
import { getCollection } from "astro:content";
import type { ImageMetadata } from "astro";
import { DEFAULT_POST_SOCIAL_IMAGE } from "../consts";
import { extractDescription } from "../utils/extractDescription";

interface PostMeta {
    title: string;
    description: string;
    image?: string;
}

interface Props {
    meta?: Record<string, PostMeta>;
}

const { meta } = Astro.props as Props;

const normalizeMetaMap = (map: Record<string, PostMeta>): Record<string, PostMeta> =>
    Object.entries(map).reduce<Record<string, PostMeta>>((acc, [id, value]) => {
        acc[id] = {
            ...value,
            image: value.image || DEFAULT_POST_SOCIAL_IMAGE,
        };
        return acc;
    }, {});

// Helper to extract image URL from socialImage (ImageMetadata or string)
const getImageUrl = (socialImage: ImageMetadata | string | undefined): string | undefined => {
    if (!socialImage) return undefined;
    // If it's an ImageMetadata object (local image), extract src
    if (typeof socialImage === 'object' && 'src' in socialImage) {
        return socialImage.src;
    }
    // Otherwise it's a string (external URL or /public/ path)
    return socialImage;
};

let postMetaMap: Record<string, PostMeta>;

if (meta) {
    postMetaMap = meta;
} else {
    const blogPosts = await getCollection("blog");

    postMetaMap = blogPosts.reduce<Record<string, PostMeta>>((acc, post) => {
        const description = post.data.description || extractDescription(post.body || "");
        const imageUrl = getImageUrl(post.data.socialImage);

        acc[post.id] = {
            title: post.data.title,
            description,
            image: imageUrl,
        };
        return acc;
    }, {});
}

postMetaMap = normalizeMetaMap(postMetaMap);

const serializedMeta = JSON.stringify(postMetaMap).replace(/</g, "\\u003c");
---
<script id="all-posts-meta" type="application/json" set:html={serializedMeta} is:inline></script>
<script>
	import { initPostPreview } from '../scripts/postPreview.ts';
	initPostPreview(document);
</script>
