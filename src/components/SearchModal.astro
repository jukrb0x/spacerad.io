---
import { getLangFromUrl, t } from '../utils/i18n';

const lang = getLangFromUrl(Astro.url);
---

<!-- Search Modal Overlay -->
<div
  id="search-modal"
  class="fixed inset-0 z-[100] hidden"
  role="dialog"
  aria-modal="true"
  aria-label="Search"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" data-search-backdrop></div>

  <!-- Modal Content -->
  <div class="relative flex items-start justify-center pt-[15vh] px-4">
    <div class="w-full max-w-xl bg-surface border border-border rounded-xl shadow-2xl overflow-hidden">
      <!-- Search Input -->
      <div class="flex items-center gap-3 p-4 border-b border-border">
        <span class="i-ph:magnifying-glass text-xl text-muted"></span>
        <input
          type="search"
          id="search-input"
          placeholder={t('search.placeholder', lang)}
          class="flex-1 bg-transparent text-lg outline-none placeholder:text-muted"
          autocomplete="off"
        />
        <kbd class="hidden sm:inline-flex px-2 py-1 text-xs text-muted bg-background border border-border rounded">
          ESC
        </kbd>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="max-h-[50vh] overflow-y-auto p-2">
        <p class="p-4 text-center text-muted text-sm">
          {lang === 'zh' ? '输入关键词开始搜索...' : 'Start typing to search...'}
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  let pagefind: any = null;

  // Initialize search functionality
  function initSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input') as HTMLInputElement;
    const results = document.getElementById('search-results');
    const trigger = document.getElementById('search-trigger');
    const backdrop = document.querySelector('[data-search-backdrop]');

    if (!modal || !input || !results) return;

    // Open modal
    function openModal() {
      modal.classList.remove('hidden');
      document.body.classList.add('scroll-locked');
      input.focus();
      loadPagefind();
    }

    // Close modal
    function closeModal() {
      modal.classList.add('hidden');
      document.body.classList.remove('scroll-locked');
      input.value = '';
      results.innerHTML = '<p class="p-4 text-center text-muted text-sm">Start typing to search...</p>';
    }

    // Load Pagefind on first open
    async function loadPagefind() {
      if (pagefind) return;

      try {
        // Pagefind is generated at build time, load dynamically
        const pagefindPath = '/pagefind/pagefind.js';
        pagefind = await import(/* @vite-ignore */ pagefindPath);
        await pagefind.init();
      } catch (e) {
        console.warn('Pagefind not available - run `pnpm build` first');
        results.innerHTML = '<p class="p-4 text-center text-muted text-sm">Search not available in dev mode. Run build first.</p>';
      }
    }

    // Perform search
    async function search(query: string) {
      if (!query.trim()) {
        results.innerHTML = '<p class="p-4 text-center text-muted text-sm">Start typing to search...</p>';
        return;
      }

      if (!pagefind) {
        results.innerHTML = '<p class="p-4 text-center text-muted text-sm">Loading search...</p>';
        await loadPagefind();
        if (!pagefind) return;
      }

      const searchResults = await pagefind.search(query);

      if (searchResults.results.length === 0) {
        results.innerHTML = '<p class="p-4 text-center text-muted text-sm">No results found</p>';
        return;
      }

      const items = await Promise.all(
        searchResults.results.slice(0, 10).map(async (r: any) => {
          const data = await r.data();
          return `
            <a href="${data.url}" class="block p-3 rounded-lg hover:bg-background transition-colors">
              <h3 class="font-medium text-primary">${data.meta?.title || data.url}</h3>
              <p class="text-sm text-secondary mt-1 line-clamp-2">${data.excerpt}</p>
            </a>
          `;
        })
      );

      results.innerHTML = items.join('');
    }

    // Event listeners
    trigger?.addEventListener('click', openModal);
    backdrop?.addEventListener('click', closeModal);

    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      search(target.value);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K to open
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('hidden')) {
          openModal();
        } else {
          closeModal();
        }
      }

      // ESC to close
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
  }

  // Initialize on page load
  document.addEventListener('astro:page-load', initSearch);
  initSearch();
</script>
