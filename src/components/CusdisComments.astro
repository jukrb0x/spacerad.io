---
import { CUSDIS_CONFIG } from '../consts';

interface Props {
  pageId: string;
  pageTitle: string;
  lang?: 'en' | 'zh';
}

const { pageId, pageTitle, lang = 'en' } = Astro.props;
const { appId, host } = CUSDIS_CONFIG;
---

<div
  id="cusdis_thread"
  data-host={host}
  data-app-id={appId}
  data-page-id={pageId}
  data-page-title={pageTitle}
  data-theme="auto"
>
</div>

<script is:inline define:vars={{ host }}>
  // Load Cusdis script
  if (!document.getElementById('cusdis-script')) {
    const script = document.createElement('script');
    script.id = 'cusdis-script';
    script.src = `${host}/js/cusdis.es.js`;
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
  }

  // Theme sync
  function syncCusdisTheme() {
    const theme = document.documentElement.getAttribute('data-theme');
    if (window.CUSDIS) {
      window.CUSDIS.setTheme(theme === 'dark' ? 'dark' : 'light');
    }
  }

  // Observe theme changes
  const observer = new MutationObserver(syncCusdisTheme);
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme'],
  });

  // Initial sync when Cusdis loads
  window.addEventListener('load', () => {
    setTimeout(syncCusdisTheme, 500);
  });
</script>
