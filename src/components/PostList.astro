---
import { getPublishedPosts, groupPostsByYear } from "../utils/posts";
import PostItem from "./PostItem.astro";

const posts = await getPublishedPosts();
const groupedPosts = groupPostsByYear(posts);
---

<section class="section-stack">
	<div class="flex items-center justify-end mb-4">
		<div class="lang-switcher inline-flex select-none items-center gap-1 text-sm text-muted">
			<button
				id="lang-all"
				type="button"
				class="lang-btn px-2 py-0.5 rounded transition-colors"
				data-lang="all"
			>All</button>
			<button
				id="lang-en"
				type="button"
				class="lang-btn px-2 py-0.5 rounded transition-colors"
				data-lang="en"
			>EN</button>
			<button
				id="lang-zh"
				type="button"
				class="lang-btn px-2 py-0.5 rounded transition-colors"
				data-lang="zh"
			>中文</button>
		</div>
	</div>
	{
		groupedPosts.map(([year, yearPosts]) => (
			<div class="relative" data-year-group>
				{/* Year in background - closer to first post */}
				<div class="relative h-14 pointer-events-none select-none">
					<span class="absolute -left-7 sm:-left-10 -top-1 text-8xl sm:text-9xl font-bold opacity-[0.06] text-primary">
						{year}
					</span>
				</div>

				<ul class="m-0 flex list-none flex-col gap-1 p-0 relative">
					{yearPosts.map((post) => (
						<PostItem post={post} />
					))}
				</ul>
			</div>
		))
	}
</section>

<style lang="scss">
	/* Language switcher buttons */
	.lang-btn {
		opacity: 0.5;
		&:hover {
			opacity: 0.8;
			background: color-mix(in srgb, var(--color-text-muted) 10%, transparent);
		}
		&.active {
			opacity: 1;
			background: color-mix(in srgb, var(--color-accent) 20%, transparent);
		}
	}
</style>

<script is:inline>
	document.addEventListener('DOMContentLoaded', function() {
		const yearGroups = document.querySelectorAll('[data-year-group]');
		const langButtons = document.querySelectorAll('.lang-btn');

		if (!langButtons.length) return;

		const LANG_KEY = 'posts-lang-filter';
		let currentLang = window.localStorage.getItem(LANG_KEY) || 'all';

		const setActiveButton = (lang) => {
			langButtons.forEach((btn) => {
				btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
			});
		};

		const applyFilter = (lang) => {
			currentLang = lang;
			window.localStorage.setItem(LANG_KEY, lang);
			setActiveButton(lang);

			yearGroups.forEach((group) => {
				let visibleCount = 0;
				group.querySelectorAll('li[data-lang]').forEach((item) => {
					const itemLang = item.getAttribute('data-lang');
					const shouldShow = lang === 'all' || itemLang === lang;
					item.style.display = shouldShow ? '' : 'none';
					if (shouldShow) visibleCount += 1;
				});

				const noDataIndicator = group.querySelector('.no-posts');
				if (noDataIndicator) {
					noDataIndicator.style.display = visibleCount === 0 ? 'block' : 'none';
				} else if (visibleCount === 0) {
					const emptyState = document.createElement('p');
					emptyState.className = 'no-posts text-sm text-[color-mix(in_srgb,var(--color-text-muted)_70%,transparent)] italic';
					emptyState.textContent = 'No posts in this language for this year.';
					group.querySelector('ul')?.appendChild(emptyState);
				}
			});
		};

		langButtons.forEach((btn) => {
			btn.addEventListener('click', () => {
				applyFilter(btn.getAttribute('data-lang'));
			});
		});

		applyFilter(currentLang);
	});
</script>
