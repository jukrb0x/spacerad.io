---
// NavDrawer.astro - Mobile navigation drawer (rendered outside header to avoid transform issues)
import { NAV_LINKS } from "../consts";

const pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, "");
const subpath = pathname.match(/[^/]+/g);
const isActive = (href: string) => href === pathname || href === `/${subpath?.[0] || ""}`;
---

<div
    data-nav-overlay
    class="fixed inset-0 z-50 flex items-start justify-end bg-black/30 opacity-0 transition-opacity duration-200 pointer-events-none md:hidden"
    data-nav-state="closed"
    transition:animate="none"
>
    <button
        type="button"
        class="absolute inset-0 h-full w-full cursor-default"
        data-nav-close
        aria-label="Close navigation menu"></button>
    <div
        data-nav-drawer
        data-scroll-container
        class="relative z-[100] flex h-full w-72 max-w-[80vw] translate-x-6 flex-col gap-6 border-l border-border bg-surface p-6 text-primary shadow-xl transition-transform duration-200 backdrop-blur-sm"
    >
        <div class="flex items-center justify-between">
            <span
                class="text-sm font-semibold uppercase tracking-[0.25em] text-[color-mix(in_srgb,var(--color-text-muted)_70%,transparent)]"
            >
                Menu
            </span>
            <button
                type="button"
                class="icon-btn icon-btn--xs icon-btn--square focus-accent"
                data-nav-close
                aria-label="Close navigation menu"
            >
                <span aria-hidden="true" class="text-xl leading-none">Ã—</span>
            </button>
        </div>
        <nav class="flex flex-col gap-2 text-base" data-no-preview>
            {
                NAV_LINKS.map((link) => (
                    <a
                        href={link.href}
                        class:list={[
                            "no-underline inline-flex items-center rounded-md px-3 py-2 transition-interactive focus-accent",
                            isActive(link.href)
                                ? "text-muted cursor-default"
                                : "text-secondary hover:text-accent hover:bg-accent-tint-8",
                        ]}
                        data-nav-link
                    >
                        {link.label}
                    </a>
                ))
            }
        </nav>
    </div>
</div>

<script>
    import { lockScroll, unlockScroll } from "../utils/scrollLock";

    // AbortController for document-level listeners so we can clean up on re-init
    let drawerAbort: AbortController | null = null;

    function initNavDrawer() {
        const toggleButton = document.querySelector<HTMLButtonElement>("[data-nav-toggle]");
        const overlay = document.querySelector<HTMLElement>("[data-nav-overlay]");
        const drawer = document.querySelector<HTMLElement>("[data-nav-drawer]");
        const closeButtons = document.querySelectorAll<HTMLButtonElement>("[data-nav-close]");
        const navLinks = document.querySelectorAll<HTMLAnchorElement>("[data-nav-link]");
        const barTop = toggleButton?.querySelector<HTMLElement>("[data-bar-top]");
        const barMiddle = toggleButton?.querySelector<HTMLElement>("[data-bar-middle]");
        const barBottom = toggleButton?.querySelector<HTMLElement>("[data-bar-bottom]");
        let lastFocusedElement: Element | null = null;

        if (!overlay || !drawer) return;

        // Clean up previous document-level listeners
        drawerAbort?.abort();
        drawerAbort = new AbortController();
        const { signal } = drawerAbort;

        const toggleClasses = (el: Element | null | undefined, add: string[], remove: string[]) => {
            if (!el) return;
            el.classList.remove(...remove);
            el.classList.add(...add);
        };

        const setNavOpen = (open: boolean) => {
            if (!overlay || !drawer) return;

            overlay.dataset.navState = open ? "open" : "closed";
            toggleButton?.setAttribute("aria-expanded", String(open));
            toggleButton?.setAttribute("aria-label", open ? "Close navigation menu" : "Open navigation menu");

            if (open) {
                lastFocusedElement = document.activeElement;
                toggleClasses(overlay, ["opacity-100"], ["pointer-events-none", "opacity-0"]);
                toggleClasses(drawer, ["translate-x-0"], ["translate-x-6"]);
                toggleClasses(barTop, ["translate-y-1.5", "rotate-45"], []);
                toggleClasses(barBottom, ["-translate-y-1.5", "-rotate-45"], []);
                toggleClasses(barMiddle, ["opacity-0"], []);
                lockScroll();
                requestAnimationFrame(() => navLinks[0]?.focus({ preventScroll: true }));
            } else {
                toggleClasses(overlay, ["opacity-0", "pointer-events-none"], ["opacity-100"]);
                toggleClasses(drawer, ["translate-x-6"], ["translate-x-0"]);
                toggleClasses(barTop, [], ["translate-y-1.5", "rotate-45"]);
                toggleClasses(barBottom, [], ["-translate-y-1.5", "-rotate-45"]);
                toggleClasses(barMiddle, [], ["opacity-0"]);
                unlockScroll();
                if (lastFocusedElement && "focus" in lastFocusedElement) {
                    (lastFocusedElement as HTMLElement).focus({ preventScroll: true });
                }
            }
        };

        // Element-level listeners (auto-cleaned when DOM swaps)
        toggleButton?.addEventListener("click", () => setNavOpen(overlay?.dataset.navState !== "open"));
        closeButtons.forEach((btn) => btn.addEventListener("click", () => setNavOpen(false)));
        overlay?.addEventListener("click", (e) => e.target === overlay && setNavOpen(false));
        navLinks.forEach((link) => link.addEventListener("click", () => setNavOpen(false)));

        // Document-level listeners (cleaned via AbortController)
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && overlay?.dataset.navState === "open") {
                setNavOpen(false);
            }
        }, { signal });

        // Close drawer instantly before page swap to prevent flash
        document.addEventListener("astro:before-swap", () => {
            if (overlay.dataset.navState === "open") {
                overlay.dataset.navState = "closed";
                overlay.classList.add("opacity-0", "pointer-events-none");
                overlay.classList.remove("opacity-100");
                drawer.classList.add("translate-x-6");
                drawer.classList.remove("translate-x-0");
                toggleClasses(barTop, [], ["translate-y-1.5", "rotate-45"]);
                toggleClasses(barBottom, [], ["-translate-y-1.5", "-rotate-45"]);
                toggleClasses(barMiddle, [], ["opacity-0"]);
                unlockScroll();
            }
        }, { signal });

        const mdQuery = window.matchMedia("(min-width: 768px)");
        const handleMdChange = (e: MediaQueryListEvent) => e.matches && setNavOpen(false);
        mdQuery.addEventListener("change", handleMdChange);
        // Clean up media query listener on abort too
        signal.addEventListener("abort", () => mdQuery.removeEventListener("change", handleMdChange));
    }

    // astro:page-load fires on initial load AND after each SPA navigation,
    // so a direct call here would cause double-init (duplicate listeners) on first load.
    document.addEventListener("astro:page-load", initNavDrawer);
</script>
