---
// NavDrawer.astro - Mobile navigation drawer using <dialog> for proper iOS Safari viewport handling
import { NAV_LINKS } from "../consts";

const pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, "");
const subpath = pathname.match(/[^/]+/g);
const isActive = (href: string) => href === pathname || href === `/${subpath?.[0] || ""}`;
---

<dialog
    data-nav-overlay
    class="nav-drawer md:hidden"
    transition:animate="none"
>
    <button
        type="button"
        class="nav-drawer__backdrop"
        data-nav-close
        aria-label="Close navigation menu"></button>
    <div
        data-nav-drawer
        data-scroll-container
        class="nav-drawer__panel"
    >
        <div class="flex items-center justify-between">
            <span
                class="text-sm font-semibold uppercase tracking-[0.25em] text-[color-mix(in_srgb,var(--color-text-muted)_70%,transparent)]"
            >
                Menu
            </span>
            <button
                type="button"
                class="icon-btn icon-btn--xs icon-btn--square focus-accent"
                data-nav-close
                aria-label="Close navigation menu"
            >
                <span aria-hidden="true" class="text-xl leading-none">Ã—</span>
            </button>
        </div>
        <nav class="flex flex-col gap-2 text-base" data-no-preview>
            {
                NAV_LINKS.map((link) => (
                    <a
                        href={link.href}
                        class:list={[
                            "no-underline inline-flex items-center rounded-md px-3 py-2 transition-interactive focus-accent",
                            isActive(link.href)
                                ? "text-muted cursor-default"
                                : "text-secondary hover:text-accent hover:bg-accent-tint-8",
                        ]}
                        data-nav-link
                    >
                        {link.label}
                    </a>
                ))
            }
        </nav>
    </div>
</dialog>

<script>
    import { lockScrollForDialog, unlockScrollForDialog } from "../utils/scrollLock";

    // AbortController for document-level listeners so we can clean up on re-init
    let drawerAbort: AbortController | null = null;

    function initNavDrawer() {
        const toggleButton = document.querySelector<HTMLButtonElement>("[data-nav-toggle]");
        const overlay = document.querySelector<HTMLDialogElement>("[data-nav-overlay]");
        const drawer = document.querySelector<HTMLElement>("[data-nav-drawer]");
        const closeButtons = document.querySelectorAll<HTMLButtonElement>("[data-nav-close]");
        const navLinks = document.querySelectorAll<HTMLAnchorElement>("[data-nav-link]");
        const barTop = toggleButton?.querySelector<HTMLElement>("[data-bar-top]");
        const barMiddle = toggleButton?.querySelector<HTMLElement>("[data-bar-middle]");
        const barBottom = toggleButton?.querySelector<HTMLElement>("[data-bar-bottom]");
        let lastFocusedElement: Element | null = null;

        if (!overlay || !drawer) return;

        // Clean up previous document-level listeners
        drawerAbort?.abort();
        drawerAbort = new AbortController();
        const { signal } = drawerAbort;

        const toggleClasses = (el: Element | null | undefined, add: string[], remove: string[]) => {
            if (!el) return;
            el.classList.remove(...remove);
            el.classList.add(...add);
        };

        const setNavOpen = (open: boolean) => {
            if (!overlay || !drawer) return;

            toggleButton?.setAttribute("aria-expanded", String(open));
            toggleButton?.setAttribute("aria-label", open ? "Close navigation menu" : "Open navigation menu");

            if (open) {
                lastFocusedElement = document.activeElement;
                overlay.showModal();
                lockScrollForDialog();
                // Animate in next frame after dialog is visible
                requestAnimationFrame(() => {
                    overlay.classList.add("is-open");
                });
                toggleClasses(barTop, ["translate-y-1.5", "rotate-45"], []);
                toggleClasses(barBottom, ["-translate-y-1.5", "-rotate-45"], []);
                toggleClasses(barMiddle, ["opacity-0"], []);
                requestAnimationFrame(() => navLinks[0]?.focus({ preventScroll: true }));
            } else {
                overlay.classList.remove("is-open");
                toggleClasses(barTop, [], ["translate-y-1.5", "rotate-45"]);
                toggleClasses(barBottom, [], ["-translate-y-1.5", "-rotate-45"]);
                toggleClasses(barMiddle, [], ["opacity-0"]);
                unlockScrollForDialog();
                // Close dialog after CSS transition completes
                setTimeout(() => {
                    if (!overlay.classList.contains("is-open")) {
                        overlay.close();
                    }
                }, 200);
                if (lastFocusedElement && "focus" in lastFocusedElement) {
                    (lastFocusedElement as HTMLElement).focus({ preventScroll: true });
                }
            }
        };

        // Element-level listeners (auto-cleaned when DOM swaps)
        toggleButton?.addEventListener("click", () => setNavOpen(!overlay.open));
        closeButtons.forEach((btn) => btn.addEventListener("click", () => setNavOpen(false)));
        navLinks.forEach((link) => link.addEventListener("click", () => setNavOpen(false)));

        // Intercept browser Escape to run animated close instead
        overlay.addEventListener("cancel", (e) => {
            e.preventDefault();
            setNavOpen(false);
        });

        // Document-level listeners (cleaned via AbortController)
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && overlay.open) {
                setNavOpen(false);
            }
        }, { signal });

        // Close drawer instantly before page swap to prevent flash
        document.addEventListener("astro:before-swap", () => {
            if (overlay.open) {
                overlay.classList.remove("is-open");
                toggleClasses(barTop, [], ["translate-y-1.5", "rotate-45"]);
                toggleClasses(barBottom, [], ["-translate-y-1.5", "-rotate-45"]);
                toggleClasses(barMiddle, [], ["opacity-0"]);
                unlockScrollForDialog();
                overlay.close();
            }
        }, { signal });

        const mdQuery = window.matchMedia("(min-width: 768px)");
        const handleMdChange = (e: MediaQueryListEvent) => e.matches && setNavOpen(false);
        mdQuery.addEventListener("change", handleMdChange);
        // Clean up media query listener on abort too
        signal.addEventListener("abort", () => mdQuery.removeEventListener("change", handleMdChange));
    }

    // astro:page-load fires on initial load AND after each SPA navigation,
    // so a direct call here would cause double-init (duplicate listeners) on first load.
    document.addEventListener("astro:page-load", initNavDrawer);
</script>
